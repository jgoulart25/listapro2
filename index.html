<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ListaPro">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root { font-family: 'Inter', sans-serif; }
        .scroll-container { max-height: calc(100vh - 320px); }
        .whatsapp-icon { fill: currentColor; width: 1.25rem; height: 1.25rem; }
        .pdf-icon { fill: currentColor; width: 1.25rem; height: 1.25rem; }
        #list-modal:not([style*="display: none"]) { display: flex; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <div id="app-container" class="max-w-xl mx-auto p-4 md:p-6 w-full flex-grow">
        
        <header class="bg-white p-4 rounded-xl shadow-lg mb-4">
            <h1 class="text-3xl font-bold text-blue-700 mb-4">üõí Lista Pro</h1>
            
            <div id="loading-overlay" class="text-center text-blue-600 font-semibold py-4" style="display: none;">
                <p class="animate-pulse">Conectando ao banco de dados...</p>
            </div>
            
            <!-- Mensagens de Erro -->
            <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded shadow" role="alert">
                <p class="font-bold">Erro de Permiss√£o</p>
                <p id="error-text">O banco de dados recusou a grava√ß√£o. Verifique as Regras do Firestore.</p>
            </div>

            <div id="main-content" style="display: none;">
                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <select id="list-selector" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></select>
                    <button onclick="showListModal('create')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 flex-shrink-0">
                        Nova Lista
                    </button>
                    <button onclick="showListModal('delete')" id="delete-list-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 flex-shrink-0 disabled:opacity-50" disabled>
                        Excluir
                    </button>
                </div>

                <div class="flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <p class="text-lg font-bold text-blue-800">
                        Total: <span id="total-price" class="text-xl">R$ 0,00</span>
                    </p>
                    <div class="flex space-x-2">
                        <button onclick="exportToPDF()" title="PDF" class="p-3 bg-blue-500 hover:bg-blue-600 rounded-full text-white shadow-md transition duration-200">
                            <svg class="pdf-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3ZM12.75 16.5H11.25V14H12.75V16.5ZM16.5 10.5C16.5 9.175 15.65 8.25 14.5 8.25H9.5C8.35 8.25 7.5 9.175 7.5 10.5V16.5C7.5 17.825 8.35 18.75 9.5 18.75H14.5C15.65 18.75 16.5 17.825 16.5 16.5V10.5ZM14.5 10.5H9.5V12.75H14.5V10.5Z" fill="currentColor"/></svg>
                        </button>
                        <button onclick="shareWhatsApp()" title="WhatsApp" class="p-3 bg-green-500 hover:bg-green-600 rounded-full text-white shadow-md transition duration-200">
                            <svg class="whatsapp-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.035 1.99a10.035 10.035 0 0 0-8.914 5.378l-1.12 3.692-.008.024-1.996 6.556a1.002 1.002 0 0 0 .524 1.272l.02.016 3.593 1.838.006.002a9.96 9.96 0 0 0 14.65-.968 10.024 10.024 0 0 0 1.258-13.844 10.035 10.035 0 0 0-7.98-4.152zm-3.238 3.54a1.006 1.006 0 0 1 .494.332 1.007 1.007 0 0 1-.223 1.34c-1.22.868-2.65 1.88-3.92 2.72a.54.54 0 0 0-.2.434l.325 1.487c.07.32.32.484.58.484.148 0 .298-.052.417-.156.97-.838 2.08-1.748 3.1-2.454.218-.152.47-.234.73-.234.333 0 .63.123.864.335 1.57 1.415 3.018 2.87 4.54 4.19.467.41.87.618 1.45.618.31 0 .55-.17.658-.456l.89-2.79c.174-.54.015-1.135-.382-1.574-1.132-1.29-2.28-2.64-3.41-3.96-.28-.33-.35-.63-.26-1.04l.11-1.018c.07-.468.17-.935.26-1.402.1-.475-.152-.77-.59-.77h-.002c-.52 0-1.11.234-1.89.845-.584.466-1.157.945-1.728 1.43z" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div id="item-form-container" class="bg-white p-4 rounded-xl shadow-lg mb-4" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Adicionar Item</h2>
            <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-6 gap-3">
                <input type="text" id="item-name" placeholder="Nome (Ex: Leite)" required class="md:col-span-2 p-3 border border-gray-300 rounded-lg">
                <input type="number" id="item-quantity" placeholder="Qtd" min="1" value="1" class="md:col-span-1 p-3 border border-gray-300 rounded-lg">
                <input type="number" id="item-price" placeholder="Pre√ßo" step="0.01" class="md:col-span-2 p-3 border border-gray-300 rounded-lg">
                <button type="submit" class="md:col-span-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200">Add</button>
            </form>
        </div>

        <div id="list-items-container" class="bg-white p-4 rounded-xl shadow-lg mb-4" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Itens</h2>
            <div id="shopping-list" class="scroll-container overflow-y-auto divide-y divide-gray-100">
                <p id="empty-list-message" class="text-gray-500 text-center py-6">Lista vazia.</p>
            </div>
        </div>
        
        <div class="text-xs text-gray-400 text-center mt-auto pb-4">
            App ID: listapro-6ef73 | User ID: <span id="debug-user-id">...</span>
        </div>
    </div>

    <div id="list-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" style="display: none;">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <div id="modal-body"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="modal-action-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg"></button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        // =================================================================
        // CONFIGURA√á√ÉO DO FIREBASE (J√Å PREENCHIDA)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAtY34SS6q_th0bTxbe_yY7YjjWPs0auvM",
            authDomain: "listapro-6ef73.firebaseapp.com",
            projectId: "listapro-6ef73",
            storageBucket: "listapro-6ef73.firebasestorage.app",
            messagingSenderId: "469100355228",
            appId: "1:469100355228:web:80e22df923e2c2cf0a1759"
        };
        // =================================================================
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth, userId = null, currentListId = null, shoppingLists = [], itemsUnsubscribe = null;

        const showError = (msg) => {
            console.error(msg);
            const banner = document.getElementById('error-banner');
            document.getElementById('error-text').textContent = msg;
            banner.classList.remove('hidden');
            // Esconde o banner ap√≥s 5 segundos
            setTimeout(() => banner.classList.add('hidden'), 5000);
        };

        const startApp = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('loading-overlay').style.display = 'block';
                
                // Autentica√ß√£o An√¥nima
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('debug-user-id').textContent = userId;
                        startRealtimeListeners();
                        document.getElementById('loading-overlay').style.display = 'none';
                        document.getElementById('main-content').style.display = 'block';
                        document.getElementById('item-form-container').style.display = 'block';
                        document.getElementById('list-items-container').style.display = 'block';
                    }
                });
            } catch (e) {
                console.error(e);
                showError("Falha cr√≠tica na inicializa√ß√£o: " + e.message);
            }
        };

        const generatePath = (collectionName) => {
            if (!userId) return null;
            return `artifacts/${firebaseConfig.projectId}/users/${userId}/${collectionName}`;
        };

        const startRealtimeListeners = () => {
            const path = generatePath("shopping_lists");
            if(!path) return;

            // Listener de Listas
            onSnapshot(query(collection(db, path), orderBy("createdAt", "desc")), 
                (snapshot) => {
                    shoppingLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderListSelector();
                    document.getElementById('delete-list-btn').disabled = shoppingLists.length === 0;
                }, 
                (error) => {
                    if (error.code === 'permission-denied') {
                        showError("Permiss√£o Negada! Atualize as Regras do Firestore para permitir subcole√ß√µes (document=**).");
                    } else {
                        showError("Erro ao carregar listas: " + error.message);
                    }
                }
            );
        };

        const startItemsListener = (listId) => {
            if (itemsUnsubscribe) itemsUnsubscribe();
            if (!listId) { renderItems([]); return; }

            const path = generatePath(`shopping_lists/${listId}/items`);
            
            // Listener de Itens
            itemsUnsubscribe = onSnapshot(query(collection(db, path), orderBy("isBought", "asc"), orderBy("name", "asc")), 
                (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderItems(items);
                },
                (error) => {
                    if (error.code === 'permission-denied') {
                        showError("Erro: N√£o √© poss√≠vel ler os itens. Verifique a regra recursiva (**).");
                    }
                }
            );
        };

        // --- UI RENDER ---
        const renderListSelector = () => {
            const selector = document.getElementById('list-selector');
            selector.innerHTML = '';
            
            if (shoppingLists.length === 0) {
                selector.innerHTML = '<option value="">Nenhuma lista</option>';
                currentListId = null;
                renderItems([]);
                return;
            }

            let listToSelect = currentListId;
            if (!listToSelect || !shoppingLists.find(l => l.id === listToSelect)) {
                listToSelect = shoppingLists[0].id;
            }

            shoppingLists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = list.name;
                if (list.id === listToSelect) option.selected = true;
                selector.appendChild(option);
            });

            if (currentListId !== listToSelect) {
                currentListId = listToSelect;
                startItemsListener(currentListId);
            }
        };

        const renderItems = (items) => {
            const container = document.getElementById('shopping-list');
            container.innerHTML = '';
            let total = 0;

            if (items.length === 0) {
                document.getElementById('empty-list-message').style.display = 'block';
            } else {
                document.getElementById('empty-list-message').style.display = 'none';
            }

            items.forEach(item => {
                const totalItem = (item.price || 0) * (item.quantity || 1);
                total += totalItem;
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3 border-b ${item.isBought ? 'bg-green-50 opacity-70' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow">
                        <input type="checkbox" ${item.isBought ? 'checked' : ''} class="w-5 h-5 cursor-pointer" onchange="toggleBought('${item.id}', this.checked)">
                        <div class="${item.isBought ? 'line-through text-gray-500' : ''}">
                            <div class="font-bold">${item.name}</div>
                            <div class="text-sm text-gray-500">${item.quantity} x R$ ${(item.price||0).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">R$ ${totalItem.toFixed(2)}</span>
                        <button onclick="deleteItem('${item.id}')" class="text-red-500 p-2 hover:bg-red-100 rounded-full">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(div);
            });
            document.getElementById('total-price').textContent = `R$ ${total.toFixed(2)}`;
        };

        // --- A√á√ïES ---
        window.showListModal = (action) => {
            const modal = document.getElementById('list-modal');
            const btn = document.getElementById('modal-action-btn');
            document.getElementById('modal-body').innerHTML = '';
            modal.style.display = 'flex';

            if (action === 'create') {
                document.getElementById('modal-title').textContent = 'Nova Lista';
                document.getElementById('modal-body').innerHTML = '<input id="new-list-name" class="w-full p-2 border rounded" placeholder="Nome da Lista">';
                btn.textContent = 'Criar';
                btn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded';
                btn.onclick = createList;
                setTimeout(() => document.getElementById('new-list-name').focus(), 100);
            } else {
                document.getElementById('modal-title').textContent = 'Excluir Lista';
                document.getElementById('modal-body').innerHTML = '<p>Tem certeza? Todos os itens ser√£o apagados.</p>';
                btn.textContent = 'Excluir';
                btn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded';
                btn.onclick = deleteList;
            }
        };

        window.hideModal = () => document.getElementById('list-modal').style.display = 'none';

        window.createList = async () => {
            const name = document.getElementById('new-list-name').value;
            if (!name) return;
            try {
                await addDoc(collection(db, generatePath("shopping_lists")), {
                    name, createdAt: new Date()
                });
                hideModal();
            } catch (e) {
                console.error(e);
                if (e.code === 'permission-denied') {
                    showError("Erro: Permiss√£o Negada. O banco n√£o permitiu criar a lista.");
                } else {
                    showError("Erro ao criar lista: " + e.message);
                }
            }
        };

        window.deleteList = async () => {
            if (!currentListId) return;
            try {
                // Nota: Em apps reais, usar√≠amos Cloud Functions para deletar subcole√ß√µes recursivamente.
                // Aqui, deletamos apenas a refer√™ncia da lista. Os itens ficar√£o "√≥rf√£os" mas invis√≠veis.
                const listPath = generatePath("shopping_lists");
                await deleteDoc(doc(db, listPath, currentListId));
                hideModal();
            } catch(e) { 
                console.error(e); 
                showError("Erro ao excluir. Verifique se voc√™ tem permiss√£o."); 
            }
        };

        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentListId) return alert("Crie uma lista primeiro.");
            
            const name = document.getElementById('item-name').value;
            const qtd = document.getElementById('item-quantity').value;
            const price = document.getElementById('item-price').value;

            try {
                await addDoc(collection(db, generatePath(`shopping_lists/${currentListId}/items`)), {
                    name, quantity: Number(qtd), price: Number(price), isBought: false
                });
                e.target.reset();
                document.getElementById('item-quantity').value = 1; // Reset manual para 1
                document.getElementById('item-name').focus();
            } catch (err) {
                console.error(err);
                if (err.code === 'permission-denied') {
                    alert("ERRO: N√£o foi poss√≠vel salvar o item.\n\nCausa: O banco de dados bloqueou a escrita.\nSolu√ß√£o: Use a regra com 'document=**' no console do Firebase.");
                } else {
                    alert("Erro ao salvar item: " + err.message);
                }
            }
        });

        window.toggleBought = async (id, val) => {
             try {
                await updateDoc(doc(db, generatePath(`shopping_lists/${currentListId}/items`), id), { isBought: val });
             } catch (e) { showError("Erro ao atualizar item."); }
        };

        window.deleteItem = async (id) => {
            if(confirm("Excluir item?")) {
                try {
                    await deleteDoc(doc(db, generatePath(`shopping_lists/${currentListId}/items`), id));
                } catch (e) { showError("Erro ao excluir item."); }
            }
        };

        document.getElementById('list-selector').addEventListener('change', (e) => {
            currentListId = e.target.value;
            startItemsListener(currentListId);
        });

        window.shareWhatsApp = () => {
             if(!currentListId) return;
             const text = `Lista: ${shoppingLists.find(l=>l.id===currentListId).name}`;
             window.open(`whatsapp://send?text=${encodeURIComponent(text)}`);
        };
        
        window.exportToPDF = () => {
             if(!currentListId) return;
             const doc = new window.jspdf.jsPDF();
             doc.text(`Lista: ${shoppingLists.find(l=>l.id===currentListId).name}`, 10, 10);
             doc.save("lista.pdf");
        };

        window.addEventListener('load', startApp);
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
    </script>
</body>
</html>
