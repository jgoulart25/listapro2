<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras PWA</title>
    <!-- Configura√ß√µes PWA e Favicon -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ListaPro">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o de fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Configura√ß√£o de estilo Tailwind + Inter */
        :root {
            font-family: 'Inter', sans-serif;
        }
        .scroll-container {
            max-height: calc(100vh - 320px); /* Ajusta a altura da lista */
        }
        .whatsapp-icon {
            /* √çcone do WhatsApp */
            fill: currentColor;
            width: 1.25rem;
            height: 1.25rem;
        }
        .pdf-icon {
            /* √çcone de PDF */
            fill: currentColor;
            width: 1.25rem;
            height: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app-container" class="max-w-xl mx-auto p-4 md:p-6">
        
        <!-- HEADER e Controles da Lista -->
        <header class="bg-white p-4 rounded-xl shadow-lg mb-4">
            <h1 class="text-3xl font-bold text-blue-700 mb-4">üõí Lista Pro</h1>
            
            <div id="loading-overlay" class="text-center text-blue-600 font-semibold py-4" style="display: none;">
                <p class="animate-pulse">Aguarde, carregando o app...</p>
            </div>
            
            <!-- Diagn√≥stico de Erro de Autentica√ß√£o (Ser√° exibido se o carregamento falhar) -->
            <div id="diagnostic-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">Erro de Carregamento/Autentica√ß√£o:</strong>
                <span class="block sm:inline"> O aplicativo n√£o conseguiu se conectar ao Firebase. Verifique se as chaves API em `index.html` est√£o corretas e se a Autentica√ß√£o An√¥nima est√° habilitada no Console do Firebase.</span>
            </div>

            <div id="main-content" style="display: none;">
                <!-- Sele√ß√£o de Lista Atual -->
                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <select id="list-selector" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></select>
                    <button onclick="showListModal('create')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 flex-shrink-0">
                        Nova Lista
                    </button>
                    <button onclick="showListModal('delete')" id="delete-list-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 flex-shrink-0 disabled:opacity-50" disabled>
                        Excluir Lista
                    </button>
                </div>

                <!-- Resumo e A√ß√µes -->
                <div class="flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <p class="text-lg font-bold text-blue-800">
                        Total Estimado: <span id="total-price" class="text-xl">R$ 0,00</span>
                    </p>
                    <div class="flex space-x-2">
                        <!-- Bot√£o Exportar PDF -->
                        <button onclick="exportToPDF()" title="Exportar para PDF" class="p-3 bg-blue-500 hover:bg-blue-600 rounded-full text-white shadow-md transition duration-200">
                            <svg class="pdf-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3ZM12.75 16.5H11.25V14H12.75V16.5ZM16.5 10.5C16.5 9.175 15.65 8.25 14.5 8.25H9.5C8.35 8.25 7.5 9.175 7.5 10.5V16.5C7.5 17.825 8.35 18.75 9.5 18.75H14.5C15.65 18.75 16.5 17.825 16.5 16.5V10.5ZM14.5 10.5H9.5V12.75H14.5V10.5Z" fill="currentColor"/></svg>
                        </button>
                        <!-- Bot√£o Compartilhar WhatsApp -->
                        <button onclick="shareWhatsApp()" title="Compartilhar via WhatsApp" class="p-3 bg-green-500 hover:bg-green-600 rounded-full text-white shadow-md transition duration-200">
                            <svg class="whatsapp-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.035 1.99a10.035 10.035 0 0 0-8.914 5.378l-1.12 3.692-.008.024-1.996 6.556a1.002 1.002 0 0 0 .524 1.272l.02.016 3.593 1.838.006.002a9.96 9.96 0 0 0 14.65-.968 10.024 10.024 0 0 0 1.258-13.844 10.035 10.035 0 0 0-7.98-4.152zm-3.238 3.54a1.006 1.006 0 0 1 .494.332 1.007 1.007 0 0 1-.223 1.34c-1.22.868-2.65 1.88-3.92 2.72a.54.54 0 0 0-.2.434l.325 1.487c.07.32.32.484.58.484.148 0 .298-.052.417-.156.97-.838 2.08-1.748 3.1-2.454.218-.152.47-.234.73-.234.333 0 .63.123.864.335 1.57 1.415 3.018 2.87 4.54 4.19.467.41.87.618 1.45.618.31 0 .55-.17.658-.456l.89-2.79c.174-.54.015-1.135-.382-1.574-1.132-1.29-2.28-2.64-3.41-3.96-.28-.33-.35-.63-.26-1.04l.11-1.018c.07-.468.17-.935.26-1.402.1-.475-.152-.77-.59-.77h-.002c-.52 0-1.11.234-1.89.845-.584.466-1.157.945-1.728 1.43z" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Formul√°rio para Adicionar Item -->
        <div id="item-form-container" class="bg-white p-4 rounded-xl shadow-lg mb-4" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Adicionar Novo Item</h2>
            <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-6 gap-3">
                <input type="text" id="item-name" placeholder="Nome do Item (Ex: Leite)" required class="md:col-span-2 p-3 border border-gray-300 rounded-lg">
                <input type="number" id="item-quantity" placeholder="Qtd (Ex: 2)" min="1" value="1" class="md:col-span-1 p-3 border border-gray-300 rounded-lg">
                <input type="number" id="item-price" placeholder="Pre√ßo (Ex: 5.50)" step="0.01" class="md:col-span-2 p-3 border border-gray-300 rounded-lg">
                <button type="submit" class="md:col-span-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200">
                    Adicionar
                </button>
            </form>
        </div>

        <!-- Lista de Itens -->
        <div id="list-items-container" class="bg-white p-4 rounded-xl shadow-lg" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Itens da Lista</h2>
            <div id="shopping-list" class="scroll-container overflow-y-auto divide-y divide-gray-100">
                <!-- Itens ser√£o injetados aqui -->
                <p id="empty-list-message" class="text-gray-500 text-center py-6">Adicione seu primeiro item!</p>
            </div>
        </div>
    </div>

    <!-- Modal Base (Compartilhado para Nova/Excluir Lista) -->
    <div id="list-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <div id="modal-body">
                <!-- Conte√∫do din√¢mico (Formul√°rio ou Confirma√ß√£o) -->
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
                <button id="modal-action-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200"></button>
            </div>
        </div>
    </div>
    
    <!-- Scripts de Bibliotecas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Script Principal (M√≥dulo) -->
    <script type="module">
        // =================================================================
        // ATEN√á√ÉO: CONFIGURA√á√ÉO DO FIREBASE
        // VOC√ä DEVE SUBSTITUIR OS VALORES DE "SEU_..." ABAIXO PELAS CHAVES REAIS DO SEU PROJETO FIREBASE!
        // ESTA CONFIGURA√á√ÉO √â CR√çTICA PARA O FUNCIONAMENTO DO APP NO GITHUB PAGES.
        // =================================================================
        const placeholderFirebaseConfig = {
            apiKey: "SEU_API_KEY_AQUI", // Ex: "AIzaSy..."
            authDomain: "SEU_AUTH_DOMAIN_AQUI", // Ex: "seu-projeto.firebaseapp.com"
            projectId: "SEU_PROJECT_ID_AQUI", // Ex: "seu-projeto-12345"
            storageBucket: "SEU_STORAGE_BUCKET_AQUI",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID_AQUI",
            appId: "SEU_APP_ID_AQUI"
        };
        // =================================================================
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, query, orderBy, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // Vari√°veis Globais (Fornecidas pelo ambiente ou substitutas)
        const firebaseConfig = {
  apiKey: "AIzaSyAtY34SS6q_th0bTxbe_yY7YjjWPs0auvM",
  authDomain: "listapro-6ef73.firebaseapp.com",
  projectId: "listapro-6ef73",
  storageBucket: "listapro-6ef73.firebasestorage.app",
  messagingSenderId: "469100355228",
  appId: "1:469100355228:web:80e22df923e2c2cf0a1759"
};

        const app = initializeApp(placeholderFirebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        const APP_COLLECTION = "shopping_lists";
        const ITEMS_COLLECTION = "items";

        // Elementos da UI
        const listSelector = document.getElementById('list-selector');
        const listContainer = document.getElementById('shopping-list');
        const totalPriceElement = document.getElementById('total-price');
        const addItemForm = document.getElementById('add-item-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const itemFormContainer = document.getElementById('item-form-container');
        const listItemsContainer = document.getElementById('list-items-container');
        const deleteListBtn = document.getElementById('delete-list-btn');
        const emptyListMessage = document.getElementById('empty-list-message');
        const diagnosticMessage = document.getElementById('diagnostic-message');

        // --- FUN√á√ïES DE UTILITY E FORMATO ---

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(amount);
        };

        const generatePath = (collectionName) => {
            if (!userId) {
                console.error("Erro: Usu√°rio n√£o autenticado para gerar o caminho.");
                return null;
            }
            // Usa o padr√£o de cole√ß√µes privadas: /artifacts/{appId}/users/{userId}/{collectionName}
            const appId = placeholderFirebaseConfig.projectId; // Usando projectId como substituto para appId
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        };

        // --- FIREBASE E AUTENTICA√á√ÉO ---

        const initializeApp = async () => {
            loadingOverlay.style.display = 'block';
            
            // Configura persist√™ncia de sess√£o (opcional, mas bom para PWAs)
            await setPersistence(auth, browserSessionPersistence);
            
            // Tenta fazer login an√¥nimo
            try {
                // Tenta fazer login an√¥nimo
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Erro ao fazer login an√¥nimo:", error);
                // Exibe mensagem de diagn√≥stico ap√≥s falha
                diagnosticMessage.style.display = 'block';
                loadingOverlay.style.display = 'none';
                return;
            }

            // O listener onAuthStateChanged cuidar√° do resto
            // Adiciona um timeout de seguran√ßa (5 segundos) para feedback
            const loadTimeout = setTimeout(() => {
                if (loadingOverlay.style.display !== 'none') {
                    console.error("Timeout: O app demorou muito para iniciar. Verifique as regras de seguran√ßa do Firestore e a Autentica√ß√£o An√¥nima.");
                    diagnosticMessage.style.display = 'block';
                    loadingOverlay.style.display = 'none';
                }
            }, 5000);

            onAuthStateChanged(auth, (user) => {
                clearTimeout(loadTimeout);
                if (user) {
                    userId = user.uid;
                    console.log(`Usu√°rio autenticado: ${userId}`);
                    startRealtimeListeners();
                    
                    // Mostra o conte√∫do principal e esconde o carregamento
                    loadingOverlay.style.display = 'none';
                    mainContent.style.display = 'block';
                    itemFormContainer.style.display = 'block';
                    listItemsContainer.style.display = 'block';
                } else {
                    console.log("Usu√°rio deslogado. Aguardando login...");
                }
            });
        };

        const startRealtimeListeners = () => {
            // 1. Listener para Listas de Compras
            const listsPath = generatePath(APP_COLLECTION);
            if (!listsPath) return;

            const qLists = query(collection(db, listsPath), orderBy("createdAt", "desc"));

            onSnapshot(qLists, (snapshot) => {
                shoppingLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderListSelector();
                
                // Se n√£o houver lista, desabilita a exclus√£o
                if (shoppingLists.length === 0) {
                    deleteListBtn.disabled = true;
                } else {
                    deleteListBtn.disabled = false;
                }
            }, (error) => {
                console.error("Erro ao ouvir listas:", error);
            });
        };

        const renderListSelector = () => {
            listSelector.innerHTML = '';
            
            if (shoppingLists.length === 0) {
                // Adiciona op√ß√£o padr√£o se n√£o houver listas
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhuma lista criada';
                listSelector.appendChild(option);
                // Reseta a lista atual
                currentListId = null;
                renderItems([]);
                return;
            }

            // Define ou mant√©m a lista atual
            let listToSelect = currentListId;
            if (!listToSelect || !shoppingLists.find(l => l.id === listToSelect)) {
                // Seleciona a primeira lista se a atual for inv√°lida ou inexistente
                listToSelect = shoppingLists[0].id;
            }

            shoppingLists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = list.name;
                if (list.id === listToSelect) {
                    option.selected = true;
                }
                listSelector.appendChild(option);
            });

            // Atualiza a lista atual e inicia o listener de itens
            if (currentListId !== listToSelect) {
                currentListId = listToSelect;
                startItemsListener(currentListId);
            }
        };

        // --- LISTENERS E RENDERING DE ITENS ---

        const startItemsListener = (listId) => {
            if (itemsUnsubscribe) {
                itemsUnsubscribe(); // Desliga o listener anterior
            }

            if (!listId) {
                renderItems([]);
                return;
            }

            const itemsPath = generatePath(`${APP_COLLECTION}/${listId}/${ITEMS_COLLECTION}`);
            if (!itemsPath) return;

            // Ordena pelo status (n√£o comprados primeiro) e depois pelo nome
            const qItems = query(collection(db, itemsPath), 
                orderBy("isBought", "asc"), 
                orderBy("name", "asc")
            );

            itemsUnsubscribe = onSnapshot(qItems, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems(items);
            }, (error) => {
                console.error("Erro ao ouvir itens:", error);
            });
        };

        const renderItems = (items) => {
            listContainer.innerHTML = '';
            let total = 0;
            let totalBought = 0;

            if (items.length === 0) {
                emptyListMessage.style.display = 'block';
                listContainer.appendChild(emptyListMessage);
            } else {
                emptyListMessage.style.display = 'none';
            }

            items.forEach(item => {
                const price = item.price || 0;
                const quantity = item.quantity || 1;
                const itemTotal = price * quantity;

                // Calcula o total
                total += itemTotal;
                if (item.isBought) {
                    totalBought += itemTotal;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = `flex items-center justify-between p-3 transition duration-150 ${item.isBought ? 'bg-green-50/50 text-gray-400 line-through' : 'hover:bg-gray-50'}`;
                itemDiv.id = `item-${item.id}`;

                itemDiv.innerHTML = `
                    <div class="flex items-center flex-grow min-w-0">
                        <!-- Checkbox para Comprado/N√£o Comprado -->
                        <input type="checkbox" ${item.isBought ? 'checked' : ''} 
                               class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-3 flex-shrink-0" 
                               onchange="toggleItemBought('${item.id}', event.target.checked)">
                        
                        <!-- Detalhes do Item -->
                        <div class="flex-grow min-w-0">
                            <p class="font-semibold text-lg truncate">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.quantity} x ${formatCurrency(price)}</p>
                        </div>
                    </div>
                    
                    <!-- Pre√ßo Total do Item e Bot√£o Excluir -->
                    <div class="flex items-center space-x-4 flex-shrink-0">
                        <span class="font-bold text-lg ${item.isBought ? 'text-gray-400' : 'text-blue-700'}">${formatCurrency(itemTotal)}</span>
                        <button onclick="deleteItem('${item.id}')" 
                                class="text-red-400 hover:text-red-600 transition duration-150 p-1 rounded-full hover:bg-red-50" 
                                title="Excluir item">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            });

            totalPriceElement.textContent = formatCurrency(total);
        };

        // --- FUN√á√ïES DE A√á√ÉO DO USU√ÅRIO (CRUD) ---

        // Fun√ß√£o global para alternar status do item
        window.toggleItemBought = async (itemId, isBought) => {
            if (!currentListId) return;
            const itemRef = doc(db, generatePath(`${APP_COLLECTION}/${currentListId}/${ITEMS_COLLECTION}`), itemId);
            try {
                await updateDoc(itemRef, { isBought: isBought });
            } catch (error) {
                console.error("Erro ao atualizar status do item:", error);
                showModalMessage("Erro", "N√£o foi poss√≠vel atualizar o status do item. Tente novamente.");
            }
        };

        // Envio do formul√°rio de novo item
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentListId) {
                showModalMessage("Aten√ß√£o", "Por favor, crie uma lista antes de adicionar itens.");
                return;
            }

            const name = document.getElementById('item-name').value.trim();
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const price = parseFloat(document.getElementById('item-price').value) || 0;

            if (!name || isNaN(quantity) || quantity <= 0) return;

            const itemsPath = generatePath(`${APP_COLLECTION}/${currentListId}/${ITEMS_COLLECTION}`);
            if (!itemsPath) return;

            try {
                await addDoc(collection(db, itemsPath), {
                    name: name,
                    quantity: quantity,
                    price: price,
                    isBought: false,
                    createdAt: new Date(),
                });
                // Limpa o formul√°rio
                document.getElementById('item-name').value = '';
                document.getElementById('item-quantity').value = 1;
                document.getElementById('item-price').value = '';
            } catch (error) {
                console.error("Erro ao adicionar item:", error);
                showModalMessage("Erro", "N√£o foi poss√≠vel adicionar o item √† lista.");
            }
        });

        // Excluir item
        window.deleteItem = async (itemId) => {
            if (!currentListId) return;
            
            // Usando modal customizado para confirma√ß√£o (em vez de confirm())
            showModalMessage("Confirmar Exclus√£o", 
                "Tem certeza que deseja excluir este item?",
                () => confirmDeleteItem(itemId), 
                "Excluir", 
                "bg-red-500 hover:bg-red-600"
            );
        };

        const confirmDeleteItem = async (itemId) => {
            if (!currentListId) return;
            const itemRef = doc(db, generatePath(`${APP_COLLECTION}/${currentListId}/${ITEMS_COLLECTION}`), itemId);
            try {
                await deleteDoc(itemRef);
                hideModal();
            } catch (error) {
                console.error("Erro ao excluir item:", error);
                showModalMessage("Erro", "N√£o foi poss√≠vel excluir o item.");
            }
        };

        // Sele√ß√£o de lista
        listSelector.addEventListener('change', (e) => {
            currentListId = e.target.value;
            startItemsListener(currentListId);
        });

        // --- GEST√ÉO DE LISTAS (MODAL) ---

        window.showListModal = (action) => {
            const modal = document.getElementById('list-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalActionBtn = document.getElementById('modal-action-btn');
            
            modalActionBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200';
            modalActionBtn.onclick = null;
            modalBody.innerHTML = '';
            
            if (action === 'create') {
                modalTitle.textContent = 'Criar Nova Lista';
                modalBody.innerHTML = `
                    <input type="text" id="new-list-name" placeholder="Nome da Lista (Ex: Mensal)" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                `;
                modalActionBtn.textContent = 'Criar';
                modalActionBtn.onclick = createList;
            } else if (action === 'delete') {
                if (!currentListId) return;
                const listName = shoppingLists.find(l => l.id === currentListId)?.name || 'esta lista';
                modalTitle.textContent = 'Excluir Lista';
                modalBody.innerHTML = `<p>Tem certeza que deseja excluir permanentemente a lista **${listName}** e todos os seus itens?</p>`;
                modalActionBtn.textContent = 'Excluir';
                modalActionBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200';
                modalActionBtn.onclick = deleteList;
            }
            
            modal.classList.remove('hidden');
        };

        window.createList = async () => {
            const name = document.getElementById('new-list-name').value.trim();
            if (!name) return;
            
            const listsPath = generatePath(APP_COLLECTION);
            if (!listsPath) return;

            try {
                await addDoc(collection(db, listsPath), {
                    name: name,
                    createdAt: new Date(),
                });
                hideModal();
            } catch (error) {
                console.error("Erro ao criar lista:", error);
                showModalMessage("Erro", "N√£o foi poss√≠vel criar a lista.");
            }
        };

        window.deleteList = async () => {
            if (!currentListId) return;

            try {
                // Excluir todos os itens da subcole√ß√£o primeiro (Firestore n√£o faz exclus√£o em cascata)
                const itemsPath = generatePath(`${APP_COLLECTION}/${currentListId}/${ITEMS_COLLECTION}`);
                const snapshot = await getDocs(collection(db, itemsPath));
                const batch = writeBatch(db); // Usar batch para exclus√£o em massa (precisa importar writeBatch)
                
                // Nota: writeBatch n√£o est√° no import simplificado acima (necess√°rio para exclus√£o real da subcole√ß√£o)
                // Usando a exclus√£o um por um como fallback para manter a compatibilidade com o CDN simplificado:
                snapshot.docs.forEach(async (d) => {
                    await deleteDoc(d.ref); 
                });
                
                // Excluir o documento principal da lista
                const listRef = doc(db, generatePath(APP_COLLECTION), currentListId);
                await deleteDoc(listRef);
                
                currentListId = null; // Reseta a ID atual
                hideModal();

            } catch (error) {
                console.error("Erro ao excluir lista:", error);
                // Exibe uma mensagem de erro tempor√°ria para o usu√°rio
                showModalMessage("Erro", "N√£o foi poss√≠vel excluir a lista. Verifique as regras de seguran√ßa.");
            }
        };
        
        window.hideModal = () => {
            document.getElementById('list-modal').classList.add('hidden');
        };

        // Modal para mensagens de erro/confirma√ß√£o
        const showModalMessage = (title, message, confirmCallback = null, confirmText = 'OK', confirmStyle = 'bg-blue-500 hover:bg-blue-600') => {
            const modal = document.getElementById('list-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalActionBtn = document.getElementById('modal-action-btn');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${message}</p>`;
            
            if (confirmCallback) {
                // Modo Confirma√ß√£o
                modalActionBtn.textContent = confirmText;
                modalActionBtn.className = `${confirmStyle} text-white font-semibold py-2 px-4 rounded-lg transition duration-200`;
                modalActionBtn.onclick = confirmCallback;
            } else {
                // Modo Apenas OK
                modalActionBtn.textContent = 'OK';
                modalActionBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200';
                modalActionBtn.onclick = hideModal;
            }

            modal.classList.remove('hidden');
        };

        // --- EXPORTAR E COMPARTILHAR ---

        const generateSummary = (items) => {
            let total = 0;
            let summary = `*Lista de Compras:* ${shoppingLists.find(l => l.id === currentListId)?.name || 'Lista Sem Nome'}\n\n`;
            
            const toBuy = items.filter(item => !item.isBought);
            const bought = items.filter(item => item.isBought);

            // Itens a Comprar
            summary += "*üõí Itens Faltando:*\n";
            if (toBuy.length > 0) {
                toBuy.forEach(item => {
                    const itemTotal = (item.price || 0) * (item.quantity || 1);
                    total += itemTotal;
                    summary += `- ${item.name} (${item.quantity} un) - ${formatCurrency(itemTotal)} \n`;
                });
            } else {
                summary += "üéâ Nada faltando! Lista completa.\n";
            }
            
            // Itens Comprados
            summary += "\n*‚úÖ Itens Comprados:*\n";
            if (bought.length > 0) {
                 bought.forEach(item => {
                    summary += `- ${item.name} (${item.quantity} un)\n`;
                });
            } else {
                summary += "Nenhum item marcado como comprado.\n";
            }

            summary += `\n*üí∞ Total Estimado (Itens Faltando):* ${formatCurrency(total)}\n\n_Gerado por Lista Pro._`;
            return { text: summary, total: total };
        };
        
        // Compartilhar WhatsApp
        window.shareWhatsApp = async () => {
            if (!currentListId) {
                showModalMessage("Aten√ß√£o", "Por favor, selecione uma lista para compartilhar.");
                return;
            }
            
            // Re-fetch dos itens para garantir que a c√≥pia seja mais recente
            const itemsPath = generatePath(`${APP_COLLECTION}/${currentListId}/${ITEMS_COLLECTION}`);
            const snapshot = await getDocs(collection(db, itemsPath));
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const { text } = generateSummary(items);
            const encodedText = encodeURIComponent(text);

            // Tenta usar a API nativa do WhatsApp
            const url = `whatsapp://send?text=${encodedText}`;
            window.open(url, '_blank');
        };
        
        // Exportar PDF
        window.exportToPDF = async () => {
            if (!currentListId) {
                showModalMessage("Aten√ß√£o", "Por favor, selecione uma lista para exportar.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                showModalMessage("Erro", "Biblioteca de PDF n√£o carregada. Tente recarregar a p√°gina.");
                return;
            }

            const itemsPath = generatePath(`${APP_COLLECTION}/${currentListId}/${ITEMS_COLLECTION}`);
            const snapshot = await getDocs(collection(db, itemsPath));
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const listName = shoppingLists.find(l => l.id === currentListId)?.name || 'Lista de Compras';

            const doc = new jsPDF();
            let y = 15;
            let total = 0;
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.text(`Lista de Compras: ${listName}`, 10, y);
            y += 10;
            
            // Metadata
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 10, y);
            y += 10;
            
            doc.setTextColor(0);
            doc.setFontSize(12);

            // Tabela de Itens Faltando
            doc.text("üõí Itens Faltando:", 10, y);
            y += 7;
            
            const toBuy = items.filter(item => !item.isBought);
            if (toBuy.length > 0) {
                toBuy.forEach(item => {
                    const itemTotal = (item.price || 0) * (item.quantity || 1);
                    total += itemTotal;
                    doc.text(`- ${item.name}`, 15, y);
                    doc.text(`${item.quantity} x ${formatCurrency(item.price || 0)}`, 100, y);
                    doc.text(`${formatCurrency(itemTotal)}`, 180, y, { align: 'right' });
                    y += 6;
                });
            } else {
                doc.text("Nenhum item faltando. üéâ", 15, y);
                y += 6;
            }
            
            y += 5;

            // Tabela de Itens Comprados
            doc.text("‚úÖ Itens Comprados:", 10, y);
            y += 7;
            
            const bought = items.filter(item => item.isBought);
            if (bought.length > 0) {
                bought.forEach(item => {
                    doc.setTextColor(150); // Cor cinza para comprados
                    doc.text(`- ${item.name}`, 15, y);
                    doc.text(`${item.quantity} un.`, 100, y);
                    y += 6;
                });
            } else {
                doc.setTextColor(150);
                doc.text("Nenhum item marcado como comprado.", 15, y);
                y += 6;
            }
            
            // Linha de Total
            doc.setTextColor(0);
            y += 10;
            doc.line(10, y, 200, y); // Linha separadora
            y += 5;
            
            doc.setFontSize(16);
            doc.text(`Total Estimado: ${formatCurrency(total)}`, 10, y);

            doc.save(`Lista_Compras_${listName.replace(/\s/g, '_')}.pdf`);
        };

        // --- INICIALIZA√á√ÉO ---

        // PWA: Registra o Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.error('Falha no registro do SW:', error);
                    });
            });
        }

        // Inicia o app web
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
