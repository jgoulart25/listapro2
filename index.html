<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras Inteligente</title>
    <!-- Configura√ß√£o do PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <!-- Meta tags para iOS (Apple) PWA installation -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ListaPro">
    <!-- Icone iOS (Usando Placeholder como fallback) -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2563eb/ffffff?text=L">
    
    <!-- Carrega Tailwind CSS para estiliza√ß√£o moderna -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define a fonte Inter e classes responsivas do Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        /* Estiliza√ß√£o para a barra de rolagem (opcional, para um visual mais limpo) */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Container Principal do App -->
    <div id="app-container" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-4 md:p-8">

        <h1 class="text-3xl font-extrabold text-blue-800 mb-6 border-b-2 pb-2 border-blue-100 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            Minhas Listas de Compras
        </h1>

        <!-- Carregamento e Autentica√ß√£o -->
        <div id="loading-overlay" class="text-center p-8">
            <p class="text-gray-600">Aguarde, carregando o app...</p>
        </div>

        <!-- Conte√∫do Principal ap√≥s o carregamento -->
        <div id="main-content" class="hidden">

            <!-- Se√ß√£o de Sele√ß√£o de Listas -->
            <div id="list-selection-area" class="mb-8 p-4 bg-blue-50 rounded-lg shadow-inner">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <h2 class="text-xl font-semibold text-blue-700">Escolha ou Crie uma Lista:</h2>
                    <button onclick="showCreateListModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Nova Lista
                    </button>
                </div>
                <div id="lists-container" class="flex flex-wrap gap-3 scrollbar-hide overflow-x-auto pb-2">
                    <!-- As listas ser√£o renderizadas aqui -->
                </div>
            </div>

            <!-- Se√ß√£o da Lista Ativa -->
            <div id="active-list-area" class="p-4 border border-gray-200 rounded-lg shadow-lg">
                <h2 id="list-title" class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Selecione uma Lista Acima</h2>
                
                <!-- Formul√°rio de Adi√ß√£o de Item -->
                <form id="add-item-form" class="flex flex-col md:flex-row gap-2 mb-6 hidden">
                    <input type="text" id="item-name" placeholder="Nome do Item (Ex: Arroz)" required class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="number" id="item-quantity" placeholder="Qtd" value="1" min="1" class="w-16 p-3 border border-gray-300 rounded-lg text-center focus:ring-blue-500 focus:border-blue-500">
                    <input type="number" id="item-price" placeholder="Pre√ßo (Opcional)" step="0.01" min="0" class="w-24 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-200 flex items-center justify-center">
                        Adicionar
                    </button>
                </form>

                <!-- Itens da Lista -->
                <ul id="items-list" class="space-y-2">
                    <p id="empty-list-message" class="text-gray-500 italic">Esta lista est√° vazia. Adicione um item!</p>
                </ul>

                <!-- Rodap√© da Lista (Totais e A√ß√µes) -->
                <div id="list-footer" class="mt-6 pt-4 border-t-2 border-blue-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hidden">
                    
                    <!-- Totais -->
                    <div class="text-lg font-semibold text-gray-700">
                        <p>Itens Comprados: <span id="purchased-count" class="font-bold text-green-600">0</span></p>
                        <p>Total Estimado: <span id="total-price" class="font-extrabold text-blue-600">R$ 0,00</span></p>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="flex space-x-3">
                         <button onclick="showDeleteListModal()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 100 2v6a1 1 0 100-2V8z" clip-rule="evenodd" />
                            </svg>
                            Excluir Lista
                        </button>
                        
                        <!-- BOT√ÉO PDF -->
                        <button onclick="handleExportPDF()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-xl transition duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1">
                                <path fill-rule="evenodd" d="M3.75 6.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM4.5 9.75a.75.75 0 000 1.5h11a.75.75 0 000-1.5H4.5zM3.75 12.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM4.5 15.75a.75.75 0 000 1.5h11a.75.75 0 000-1.5H4.5z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M12 2.25H5.25A2.25 2.25 0 003 4.5v11.5a2.25 2.25 0 002.25 2.25h11.5A2.25 2.25 0 0019 16.5V7.5a2.25 2.25 0 00-2.25-2.25h-5.46a.75.75 0 01-.527-.22L11.47 3.28a.75.75 0 00-.53-.22H5.25z" clip-rule="evenodd" />
                            </svg>
                            Exportar PDF
                        </button>
                        
                        <button id="whatsapp-share-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-xl transition duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-1">
                                <path d="M12.001 2.001c-5.523 0-10 4.478-10 10s4.477 10 10 10 10-4.478 10-10-4.477-10-10-10zm-1.938 15.655l-2.072-.647c-.663-.207-1.16-.627-1.397-1.365l-.014-.047c-.012-.038-.007-.077.012-.112l1.393-2.616c.214-.401.127-.887-.21-1.156l-1.35-1.047c-.373-.289-.484-.81-.274-1.213l2.616-4.717c.214-.401.701-.58 1.156-.412l.647.21c.54.178.96.598 1.138 1.138l.647 2.072c.178.54-.007 1.056-.412 1.27l-1.047 1.35c-.328.423-.332 1.025-.007 1.455l2.616 4.717c.214.401.025.91-.412 1.12l-2.072.647z"/>
                            </svg>
                            Compartilhar WhatsApp
                        </button>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- Modal Base (Use para Criar Lista e Mensagens) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden transition-opacity duration-300"></div>
    <div id="modal-container" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div id="modal-content" class="flex items-center justify-center min-h-full p-4">
            <!-- Conte√∫do do Modal aqui -->
        </div>
    </div>

    <!-- Adiciona a biblioteca jsPDF para gera√ß√£o de PDF (necessita estar antes do script do m√≥dulo) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Scripts do Firebase e L√≥gica do App -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Vari√°veis Globais (Fornecidas pelo ambiente)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-shopping-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Vari√°veis de Estado do App
        let lists = [];
        let activeListId = null;
        let activeList = null;

        // Elementos do DOM
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const listsContainer = document.getElementById('lists-container');
        const listTitleEl = document.getElementById('list-title');
        const addItemForm = document.getElementById('add-item-form');
        const itemsListEl = document.getElementById('items-list');
        const emptyListMessage = document.getElementById('empty-list-message');
        const listFooter = document.getElementById('list-footer');
        const purchasedCountEl = document.getElementById('purchased-count');
        const totalPriceEl = document.getElementById('total-price');
        const whatsappShareBtn = document.getElementById('whatsapp-share-btn');

        // Modal Elements
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');

        // Helper para formatar moeda
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        // --- Fun√ß√µes de UI (Modal) ---

        /** Abre o modal com o conte√∫do HTML fornecido. */
        const showModal = (htmlContent) => {
            modalContent.innerHTML = htmlContent;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('opacity-100');
            modalContainer.classList.remove('hidden');
        };

        /** Fecha o modal. */
        const closeModal = () => {
            modalBackdrop.classList.add('hidden');
            modalContainer.classList.add('hidden');
            modalContent.innerHTML = '';
        };
        
        modalBackdrop.addEventListener('click', closeModal);

        /** Exibe o modal para criar uma nova lista. */
        window.showCreateListModal = () => {
            const html = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Criar Nova Lista</h3>
                    <form id="create-list-form">
                        <input type="text" id="new-list-name" placeholder="Nome da Lista (Ex: Churrasco)" required 
                            class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Criar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            showModal(html);
            document.getElementById('create-list-form').addEventListener('submit', handleCreateList);
        };

        /** Exibe o modal de confirma√ß√£o para deletar a lista. */
        window.showDeleteListModal = () => {
            if (!activeList) return;
            const html = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                    <h3 class="text-xl font-bold mb-4 text-red-600">Confirma√ß√£o</h3>
                    <p class="mb-6">Tem certeza que deseja <span class="font-bold">excluir a lista "${activeList.name}"</span>? Esta a√ß√£o n√£o pode ser desfeita.</p>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                            Cancelar
                        </button>
                        <button type="button" onclick="handleDeleteList()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Sim, Excluir
                        </button>
                    </div>
                </div>
            `;
            showModal(html);
        };


        // --- Fun√ß√µes de Renderiza√ß√£o (Render) ---

        /** Renderiza todos os bot√µes de lista na √°rea de sele√ß√£o. */
        const renderLists = () => {
            listsContainer.innerHTML = '';
            if (lists.length === 0) {
                listsContainer.innerHTML = '<p class="text-gray-500 italic">Nenhuma lista encontrada. Clique em "Nova Lista" para come√ßar.</p>';
                return;
            }

            lists.forEach(list => {
                const isActive = list.id === activeListId;
                const buttonClass = isActive
                    ? 'bg-blue-600 text-white shadow-lg'
                    : 'bg-white text-blue-600 border border-blue-300 hover:bg-blue-100';

                const button = document.createElement('button');
                button.textContent = list.name;
                button.className = `py-2 px-4 rounded-full font-semibold text-sm transition duration-200 whitespace-nowrap ${buttonClass}`;
                button.onclick = () => selectList(list.id);
                listsContainer.appendChild(button);
            });
        };

        /** Renderiza os itens da lista ativa e atualiza os totais. */
        const renderActiveList = () => {
            itemsListEl.innerHTML = '';

            if (!activeList) {
                listTitleEl.textContent = 'Selecione uma Lista Acima';
                addItemForm.classList.add('hidden');
                listFooter.classList.add('hidden');
                itemsListEl.innerHTML = ''; // Limpa itens
                emptyListMessage.classList.remove('hidden'); // Mostra mensagem de lista vazia
                return;
            }

            const items = activeList.items || [];
            listTitleEl.textContent = activeList.name;
            addItemForm.classList.remove('hidden');
            listFooter.classList.remove('hidden');

            if (items.length === 0) {
                emptyListMessage.classList.remove('hidden');
            } else {
                emptyListMessage.classList.add('hidden');
                
                let totalPrice = 0;
                let purchasedCount = 0;

                items.sort((a, b) => a.checked - b.checked || a.name.localeCompare(b.name));

                items.forEach(item => {
                    const li = document.createElement('li');
                    const itemTotal = (item.quantity * item.price) || 0;
                    totalPrice += itemTotal;
                    if (item.checked) {
                        purchasedCount++;
                    }

                    const checkedClass = item.checked ? 'line-through text-gray-500 bg-green-50' : 'text-gray-800 bg-white hover:bg-gray-50';

                    li.className = `flex items-center p-3 rounded-lg shadow transition duration-150 border border-gray-100 ${checkedClass}`;
                    li.innerHTML = `
                        <input type="checkbox" ${item.checked ? 'checked' : ''} 
                            class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-4 cursor-pointer" 
                            data-item-id="${item.id}" onchange="handleToggleChecked('${item.id}')">
                        
                        <div class="flex-grow">
                            <p class="font-medium text-lg">${item.name} 
                                <span class="text-sm font-normal text-gray-500 ml-1">(${item.quantity} ${item.price > 0 ? 'x ' + formatCurrency(item.price) : ''})</span>
                            </p>
                        </div>
                        
                        <span class="text-lg font-semibold w-24 text-right">
                            ${formatCurrency(itemTotal)}
                        </span>

                        <button onclick="handleDeleteItem('${item.id}')" 
                            class="ml-3 p-1 text-red-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-red-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 100 2v6a1 1 0 100-2V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    itemsListEl.appendChild(li);
                });

                // Atualiza Totais
                purchasedCountEl.textContent = purchasedCount;
                totalPriceEl.textContent = formatCurrency(totalPrice);
            }
        };

        // --- Fun√ß√µes de A√ß√£o do App (CRUD Firestore) ---

        /** Seleciona uma lista para edi√ß√£o e visualiza√ß√£o. */
        const selectList = (listId) => {
            activeListId = listId;
            activeList = lists.find(l => l.id === listId);
            renderLists(); // Re-renderiza para atualizar o estado ativo do bot√£o
            renderActiveList(); // Renderiza os detalhes da nova lista ativa
        };

        /** Lida com o envio do formul√°rio de cria√ß√£o de lista. */
        const handleCreateList = async (e) => {
            e.preventDefault();
            const listName = document.getElementById('new-list-name').value.trim();
            if (!listName || !userId) return;

            closeModal();

            try {
                const listRef = doc(db, getListCollectionPath(), crypto.randomUUID());
                await setDoc(listRef, {
                    name: listName,
                    items: [], // Inicializa com array vazio de itens
                    createdAt: new Date(),
                    userId: userId,
                });
            } catch (error) {
                console.error("Erro ao criar lista:", error);
            }
        };

        /** Lida com o envio do formul√°rio de adi√ß√£o de item. */
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!activeListId || !activeList) return;

            const name = document.getElementById('item-name').value.trim();
            const quantity = parseInt(document.getElementById('item-quantity').value, 10) || 1;
            // Garante que o pre√ßo seja um n√∫mero (0 se vazio)
            const price = parseFloat(document.getElementById('item-price').value.replace(',', '.')) || 0;

            if (!name) return;

            const newItem = {
                id: crypto.randomUUID(),
                name: name,
                quantity: quantity,
                price: price,
                checked: false,
            };

            const updatedItems = [...activeList.items, newItem];

            try {
                const listRef = doc(db, getListCollectionPath(), activeListId);
                await setDoc(listRef, { items: updatedItems }, { merge: true });
                
                // Limpa o formul√°rio ap√≥s adicionar
                document.getElementById('item-name').value = '';
                document.getElementById('item-quantity').value = '1';
                document.getElementById('item-price').value = '';
                document.getElementById('item-name').focus();

            } catch (error) {
                console.error("Erro ao adicionar item:", error);
            }
        });

        /** Alterna o status 'checked' de um item. */
        window.handleToggleChecked = async (itemId) => {
            if (!activeListId || !activeList) return;

            const updatedItems = activeList.items.map(item => {
                if (item.id === itemId) {
                    return { ...item, checked: !item.checked };
                }
                return item;
            });

            try {
                const listRef = doc(db, getListCollectionPath(), activeListId);
                await setDoc(listRef, { items: updatedItems }, { merge: true });
            } catch (error) {
                console.error("Erro ao alternar status do item:", error);
            }
        };

        /** Deleta um item da lista. */
        window.handleDeleteItem = async (itemId) => {
            if (!activeListId || !activeList) return;

            const updatedItems = activeList.items.filter(item => item.id !== itemId);

            try {
                const listRef = doc(db, getListCollectionPath(), activeListId);
                await setDoc(listRef, { items: updatedItems }, { merge: true });
            } catch (error) {
                console.error("Erro ao deletar item:", error);
            }
        };

        /** Deleta a lista ativa. */
        window.handleDeleteList = async () => {
            closeModal();
            if (!activeListId) return;

            try {
                const listRef = doc(db, getListCollectionPath(), activeListId);
                await deleteDoc(listRef);

                // Reset state after deletion
                activeListId = null;
                activeList = null;
                // onSnapshot will handle the state update and re-rendering
            } catch (error) {
                console.error("Erro ao deletar a lista:", error);
            }
        };

        // --- Fun√ß√µes de Compartilhamento (WhatsApp e PDF) ---

        /** Gera o conte√∫do de texto formatado para o PDF. */
        const generatePdfText = () => {
            if (!activeList) return "";

            const items = activeList.items || [];
            const checkedItems = items.filter(i => i.checked);
            const uncheckedItems = items.filter(i => !i.checked);
            
            const total = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            let content = [];
            content.push(`LISTA DE COMPRAS: ${activeList.name.toUpperCase()}`);
            content.push(`Data de Gera√ß√£o: ${new Date().toLocaleDateString('pt-BR')}`);
            content.push("======================================================");

            if (uncheckedItems.length > 0) {
                content.push("\n--- A COMPRAR ---");
                uncheckedItems.forEach(item => {
                    const priceText = item.price > 0 ? ` (${formatCurrency(item.price)} por und.)` : '';
                    content.push(`[ ] ${item.name} | Qtd: ${item.quantity}${priceText}`);
                });
            }

            if (checkedItems.length > 0) {
                content.push("\n--- ITENS COMPRADOS ---");
                checkedItems.forEach(item => {
                    const priceText = item.price > 0 ? ` (${formatCurrency(item.price)} por und.)` : '';
                    content.push(`[X] ${item.name} | Qtd: ${item.quantity}${priceText}`);
                });
            }

            content.push("\n======================================================");
            content.push(`TOTAL ESTIMADO: ${formatCurrency(total)}`);

            return content.join('\n');
        }

        /** Lida com a exporta√ß√£o da lista ativa para PDF. */
        window.handleExportPDF = () => {
            if (!activeList || typeof window.jspdf === 'undefined') {
                console.error("Lista ativa n√£o definida ou jsPDF n√£o carregado.");
                return;
            }

            const doc = new window.jspdf.jsPDF();
            const pdfText = generatePdfText();
            
            const lines = pdfText.split('\n');
            let y = 15; // In√≠cio do documento
            const lineHeight = 8;
            const margin = 10;

            doc.setFontSize(10);
            
            lines.forEach(line => {
                if (y + lineHeight > doc.internal.pageSize.height - margin) {
                    doc.addPage();
                    y = margin;
                }
                
                if (line.startsWith('LISTA DE COMPRAS')) {
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                } else if (line.startsWith('---')) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(line, margin, y);
                    y += lineHeight / 2; // Espa√ßo extra para cabe√ßalho
                    return;
                } else if (line.startsWith('=')) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(line, margin, y);
                    y += lineHeight / 2; // Espa√ßo extra
                    return;
                } else if (line.startsWith('TOTAL ESTIMADO')) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                } else {
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                }
                
                doc.text(line, margin, y);
                y += lineHeight;

                // Restaura o tamanho da fonte ap√≥s o cabe√ßalho principal
                if (line.startsWith('LISTA DE COMPRAS')) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                }
            });

            const fileName = `Lista_${activeList.name.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);
        };

        /** Gera a mensagem formatada para o WhatsApp. */
        const generateWhatsAppText = () => {
            if (!activeList) return "";

            const items = activeList.items || [];
            const checkedItems = items.filter(i => i.checked);
            const uncheckedItems = items.filter(i => !i.checked);

            let message = `üõí *Lista de Compras: ${activeList.name}*\n\n`;

            if (uncheckedItems.length > 0) {
                message += "‚ö†Ô∏è *A Comprar:*\n";
                uncheckedItems.forEach(item => {
                    const priceText = item.price > 0 ? ` (${formatCurrency(item.price)})` : '';
                    message += `- ${item.name} (x${item.quantity})${priceText}\n`;
                });
                message += "\n";
            }

            if (checkedItems.length > 0) {
                message += "‚úÖ *Itens Comprados/Estimados:*\n";
                checkedItems.forEach(item => {
                    const priceText = item.price > 0 ? ` (${formatCurrency(item.price)})` : '';
                    message += `- ${item.name} (x${item.quantity})${priceText}\n`;
                });
                message += "\n";
            }
            
            const total = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            message += `üí∞ *Total Estimado: ${formatCurrency(total)}*`;

            return encodeURIComponent(message);
        };

        whatsappShareBtn.addEventListener('click', () => {
            if (!activeList) return;
            const text = generateWhatsAppText();
            // Tenta abrir o link do WhatsApp
            window.open(`https://api.whatsapp.com/send?text=${text}`, '_blank');
        });


        // --- Fun√ß√µes do Firebase (Auth e Data) ---

        /** Retorna o caminho da cole√ß√£o de listas de compras. */
        const getListCollectionPath = () => {
            if (!userId) return null;
            return `artifacts/${appId}/users/${userId}/shopping_lists`;
        };

        /** Inicializa o Firebase e a Autentica√ß√£o. */
        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                loadingOverlay.textContent = "Erro: Configura√ß√£o do Firebase ausente.";
                return;
            }

            setLogLevel('debug'); // Enable Firestore logging

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // This should ideally not happen if signed in anonymously
                        userId = null; 
                    }
                    isAuthReady = true;
                    loadingOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    console.log("Auth State Changed. User ID:", userId);
                    startDataListener();
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                loadingOverlay.textContent = `Erro ao carregar (ver console): ${error.message}`;
            }
        };

        /** Inicia o listener de dados em tempo real (onSnapshot). */
        const startDataListener = () => {
            if (!isAuthReady || !userId || !db) return;

            const listCollectionRef = collection(db, getListCollectionPath());
            // Firestore does not allow orderBy() without index, which is complex. We'll sort locally by name.
            // Using query(listCollectionRef, orderBy('name', 'asc')) is risky without an index.
            // We fetch all and sort locally.
            const listsQuery = query(listCollectionRef);

            onSnapshot(listsQuery, (snapshot) => {
                const fetchedLists = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    fetchedLists.push({
                        id: doc.id,
                        ...data,
                    });
                });

                // Sort locally by name (case-insensitive)
                lists = fetchedLists.sort((a, b) => a.name.localeCompare(b.name));

                // Se a lista ativa foi deletada ou n√£o existe mais, reseta o estado.
                if (activeListId) {
                    activeList = lists.find(l => l.id === activeListId) || null;
                    if (!activeList) {
                        activeListId = null; // Lista sumiu, deseleciona.
                    }
                }

                // Se n√£o h√° lista ativa e h√° listas dispon√≠veis, seleciona a primeira.
                if (!activeListId && lists.length > 0) {
                    selectList(lists[0].id);
                }

                renderLists();
                renderActiveList();
                console.log("Dados de listas atualizados em tempo real.");
            }, (error) => {
                console.error("Erro no listener do Firestore:", error);
            });
        };

        // --- Registro do Service Worker para PWA (Progressive Web App) ---
        // Adicionamos o registro aqui, logo ap√≥s a inicializa√ß√£o do Firebase ser garantida.
        const registerServiceWorker = () => {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registrado com sucesso:', registration.scope);
                            // Exibe um prompt de instala√ß√£o (Android/Chrome)
                            // A implementa√ß√£o exata do prompt de instala√ß√£o varia por navegador.
                        })
                        .catch(err => {
                            console.error('Falha no registro do ServiceWorker:', err);
                        });
                });
            }
        };

        // Inicia o app e o registro do Service Worker
        window.onload = () => {
            initializeFirebase();
            registerServiceWorker();
        };
    </script>
</body>
</html>